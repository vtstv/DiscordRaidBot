// Prisma schema for Discord Raid Bot

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Guild {
  id        String   @id
  name      String
  timezone  String   @default("UTC")
  locale    String   @default("en")
  logChannelId String?
  archiveChannelId String?
  managerRoleId String?  // Role that can manage bot (create events, templates, etc.)
  commandPrefix String   @default("!")  // Prefix for text commands (e.g., !, $, #)
  approvalChannels String[] @default([])  // Channels that require approval for participants
  reminderIntervals String[] @default(["1h", "15m"])
  autoDeleteHours Int?      // Hours after archiving to auto-delete event message (null = never delete)
  logRetentionDays Int? @map("logretentiondays")     // Days to keep audit logs (null = keep forever)
  threadChannels String[] @default([])  // Channels where threads should be auto-created for events
  noteChannels String[] @default([]) @map("notechannels")  // Channels where participant notes are enabled (empty = all channels)
  
  // Statistics settings
  statsEnabled Boolean @default(false) @map("statsenabled")
  statsChannelId String? @map("statschannelid")
  statsMessageId String? @map("statsmessageid")  // Message ID of pinned stats embed
  statsUpdateInterval String @default("daily") @map("statsupdateinterval")  // daily, weekly, monthly
  statsAutoRoleEnabled Boolean @default(false) @map("statsautoroleenabled")
  statsTop10RoleId String? @map("statstop10roleid")  // Role for top 10 participants
  statsMinEvents Int @default(3) @map("statsminevents")  // Minimum events to appear in leaderboard
  
  // Participant notes settings
  allowParticipantNotes Boolean @default(true) @map("allowparticipantnotes")  // Allow participants to add notes
  participantNoteMaxLength Int @default(30) @map("participantnotemaxlength")  // Max characters for participant notes
  
  // View online button settings
  showViewOnlineButton Boolean @default(true) @map("showviewonlinebutton")  // Show 'View online' button in Discord messages
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates Template[]
  events    Event[]
  logEntries LogEntry[]
  statistics ParticipantStatistics[]

  @@map("guilds")
}

model Template {
  id          String   @id @default(uuid())
  guildId     String
  name        String
  description String?
  
  // Flexible template configuration stored as JSON
  // Example: { "roles": ["Tank", "Healer", "DPS"], "limits": { "Tank": 2, "Healer": 3, "DPS": 10 }, "emojiMap": { "Tank": "üõ°Ô∏è", "Healer": "üíö", "DPS": "‚öîÔ∏è" } }
  config      Json
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  events      Event[]

  @@unique([guildId, name])
  @@map("templates")
}

model Event {
  id              String    @id @default(uuid())
  guildId         String
  templateId      String?
  channelId       String
  messageId       String?
  threadId        String?   // Thread for event comments
  
  title           String
  description     String?
  startTime       DateTime
  duration        Int?      // Duration in minutes
  timezone        String    @default("UTC")
  
  maxParticipants Int?
  status          String    @default("scheduled") // scheduled, active, completed, cancelled, archived
  
  // Per-role limits and configuration
  roleConfig      Json?     // { "Tank": { "limit": 2, "emoji": "üõ°Ô∏è" }, ... }
  
  createdBy       String    // Discord user ID
  editorRoleId    String?   // Role ID that can edit this event
  requireApproval Boolean   @default(false)  // If true, participants need approval from creator
  createThread    Boolean   @default(false)  // If true, create a thread for this event
  deleteThread    Boolean   @default(true)   // If true, delete thread when event completes or is archived
  allowedRoles    String[]  @default([])     // Discord role IDs allowed to sign up (empty = all allowed)
  benchOverflow   Boolean   @default(true)   // If true, users without allowed roles go to bench; if false, signup denied
  deadline        Int?                       // Hours before event start to close signups (negative = after start, null = closes at start)
  allowNotes      Boolean?  @map("allownotes")  // Override for participant notes (null = use guild setting)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  archivedAt      DateTime?
  deletedAt       DateTime? // When event message was auto-deleted

  guild           Guild         @relation(fields: [guildId], references: [id], onDelete: Cascade)
  template        Template?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  participants    Participant[]
  logEntries      LogEntry[]

  @@index([guildId, status])
  @@index([startTime])
  @@map("events")
}

model Participant {
  id          String   @id @default(uuid())
  eventId     String
  userId      String   // Discord user ID
  username    String
  
  role        String?  // Tank, Healer, DPS, etc.
  spec        String?  // Specific specialization
  status      String   @default("confirmed") // confirmed, tentative, declined, waitlist, pending
  position    Int?     // Position in waitlist or signup order
  noShow      Boolean  @default(false) @map("noshow")  // Mark if user didn't attend
  
  note        String?  @db.VarChar(100)  // Participant's personal note (max controlled by guild settings)
  notes       String?  // Admin notes (deprecated, use 'note' for participant notes)
  joinedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId, status])
  @@map("participants")
}

model LogEntry {
  id          String   @id @default(uuid())
  guildId     String
  eventId     String?
  
  action      String   // create_event, edit_event, delete_event, signup, leave, etc.
  userId      String   // Discord user ID who performed the action
  username    String
  
  details     Json?    // Additional context about the action
  
  createdAt   DateTime @default(now())

  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([guildId, createdAt])
  @@index([eventId])
  @@map("log_entries")
}

model Reminder {
  id          String   @id @default(uuid())
  eventId     String   @map("eventid")
  interval    String   // e.g., "1h", "15m"
  messageId   String   @map("messageid")
  channelId   String   @map("channelid")
  
  sentAt      DateTime @default(now()) @map("sentat")

  @@unique([eventId, interval])
  @@index([eventId])
  @@map("reminders")
}

model ParticipantStatistics {
  id                    String   @id @default(uuid())
  userId                String   @map("userid")
  guildId               String   @map("guildid")
  
  totalEventsJoined     Int      @default(0) @map("totaleventsjoin")
  totalEventsCompleted  Int      @default(0) @map("totaleventscomp")
  totalNoShows          Int      @default(0) @map("totalnoshows")
  score                 Int      @default(0)  // Calculated: joined*1 + completed*3 - noshow*2
  rank                  Int?     // Position in guild leaderboard (null if below min threshold)
  
  lastActivityAt        DateTime @default(now()) @map("lastactivityat")
  createdAt             DateTime @default(now()) @map("createdat")
  updatedAt             DateTime @updatedAt @map("updatedat")

  guild                 Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([userId, guildId])
  @@index([guildId, score])
  @@index([guildId, rank])
  @@map("participant_statistics")
}
